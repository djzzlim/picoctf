# [Format String 0](https://play.picoctf.org/practice/challenge/433)

## Challenge Information

- **Category**: Binary Exploitation
- **Difficulty**: Easy
- **Description**: Can you use your knowledge of format strings to make the customers happy?

## Solution Overview

This challenge involves exploiting format string vulnerabilities in a program that simulates a burger shop. The program contains two vulnerable `printf()` calls that directly use user input as format strings without proper format specifiers. By carefully selecting menu items that already contain format specifiers, we can manipulate the program to trigger a segmentation fault and reveal the flag.

## Hints

- This is an introduction to format string vulnerabilities. Look up "format specifiers" if you have never seen them before.
- Just try out the different options.

## Detailed Walkthrough

### Step 1: Understanding the Challenge

The program simulates a burger shop with two customers, Patrick and Bob. Each customer chooses from a specific menu of burgers, and our goal is to satisfy both customers to get the flag.

When analyzing the source code, we find two key vulnerabilities:
- In `serve_patrick()`: `printf(choice1);` 
- In `serve_bob()`: `printf(choice2);`

Both functions use `printf()` directly with user input without a format string, creating classic format string vulnerabilities.

### Step 2: Identifying the Strategy

To progress from Patrick to Bob, we need to make the output of `printf(choice1)` exceed 64 characters (2 * BUFSIZE). Then, for Bob, we need to trigger a segmentation fault to invoke the signal handler that prints the flag.

The challenge is that we can only choose from predefined menu items, as the function `on_menu()` checks if our input exactly matches an item from the menu:

```c
int on_menu(char *burger, char *menu[], int count) {
    for (int i = 0; i < count; i++) {
        if (strcmp(burger, menu[i]) == 0)
            return 1;
    }
    return 0;
}
```

### Step 3: Exploiting the First Vulnerability (Patrick)

Looking at Patrick's menu options:
- `Breakf@st_Burger`
- `Gr%114d_Cheese`
- `Bac0n_D3luxe`

The key insight is that `Gr%114d_Cheese` contains the format specifier `%114d`, which tells `printf()` to print a decimal number with 114 characters of padding. When this item is passed directly to `printf()`, the `%114d` part is interpreted as a format specifier rather than literal text.

When we choose `Gr%114d_Cheese`, `printf()` tries to print a number with 114 spaces of padding, producing an output much longer than 64 characters and allowing us to proceed to Bob.

### Step 4: Exploiting the Second Vulnerability (Bob)

For Bob's menu, we have:
- `Pe%to_Portobello`
- `$outhwest_Burger`
- `Cla%sic_Che%s%steak`

The key item here is `Cla%sic_Che%s%steak`, which contains multiple `%s` format specifiers. When this is passed to `printf()`, each `%s` tries to interpret a value from the stack as a pointer to a string.

When `printf()` encounters a null pointer or an invalid memory address while attempting to follow these pointers, it triggers a segmentation fault, which activates the `sigsegv_handler()` function that prints the flag.

### Step 5: Executing the Exploit

Here's the complete solution:

1. When prompted for Patrick's recommendation, enter exactly: `Gr%114d_Cheese`
2. This produces a very long output with padding, allowing us to advance to Bob
3. When prompted for Bob's recommendation, enter exactly: `Cla%sic_Che%s%steak`
4. This causes `printf()` to try accessing invalid memory addresses, triggering a segmentation fault
5. The segmentation fault activates the signal handler, which prints the flag

Running the exploit:
```
Welcome to our newly-opened burger place Pico 'n Patty! Can you help the picky customers find their favorite burger?
Here comes the first customer Patrick who wants a giant bite.
Please choose from the following burgers: Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe
Enter your recommendation: Gr%114d_Cheese
Gr                                                                                                           4202954_Cheese
Good job! Patrick is happy! Now can you serve the second customer?
Sponge Bob wants something outrageous that would break the shop (better be served quick before the shop owner kicks you out!)
Please choose from the following burgers: Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak
Enter your recommendation: Cla%sic_Che%s%steak
ClaCla%sic_Che%s%steakic_Che(null)
picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_63191ce6}
```

## Flag

```
picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_63191ce6}
```

## Learning Points

- **Format String Vulnerabilities**: When user input is directly passed to `printf()` without a proper format string, it allows attackers to read or write memory and potentially crash the program.
- **Format Specifiers**: Format specifiers like `%s`, `%d`, `%x`, and `%n` can be used to manipulate program behavior when exploiting format string vulnerabilities.
- **Input Validation**: Even when input validation is used (menu item checking), improper handling of special characters can lead to security vulnerabilities.
- **Signal Handlers**: Programs may use signal handlers to catch exceptions like segmentation faults, which can be exploited as part of an attack chain.

## Mitigation Strategies

To prevent format string vulnerabilities:
- Validate and sanitize user input to remove potentially harmful format specifiers
- Use compiler flags like `-Wformat-security` to catch potential format string vulnerabilities
- Consider safer alternatives like `puts()` for printing strings without formatting

## References

- [Format String Attack](https://owasp.org/www-community/attacks/Format_string_attack)
- [Exploiting Format String Vulnerabilities](https://cs155.stanford.edu/papers/formatstring-1.2.pdf)